<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DG Seller | My Items Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg: #020617; --card: #0f172a; --primary: #6366f1;
            --accent: #10b981; --text: #f8fafc; --border: rgba(255, 255, 255, 0.1);
            --gold: #fbbf24;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 90px; }
        .hidden { display: none !important; }

        /* --- LUXURY POST CARD --- */
        .post-card { background: var(--card); border-radius: 30px; margin-bottom: 20px; border: 1px solid var(--border); overflow: hidden; position: relative; transition: 0.3s; }
        .price-tag { position: absolute; top: 15px; left: 15px; background: var(--primary); color: white; padding: 6px 14px; border-radius: 12px; font-weight: 800; font-size: 0.9rem; z-index: 10; }
        .pod-badge { background: rgba(16, 185, 129, 0.2); color: var(--accent); padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; margin-top: 5px; display: inline-block; }
        
        /* --- ACTION BUTTONS --- */
        .btn-buy { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 15px; font-weight: 700; width: 100%; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-buy:active { transform: scale(0.95); }

        /* --- CHECKOUT MODAL --- */
        #checkout-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 25px; width: 100%; max-width: 400px; border: 1px solid var(--border); }
        
        input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: #1e293b; color: white; margin-top: 10px; }
    </style>
</head>
<body>

    <header style="padding: 20px; display: flex; justify-content: space-between; align-items: center; background: var(--glass); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100;">
        <b style="font-size: 1.4rem; letter-spacing: -1px;">DG <span style="color:var(--primary)">ELITE</span></b>
        <i data-lucide="shopping-bag" style="color: var(--gold)"></i>
    </header>

    <div class="container" style="max-width: 600px; margin: 0 auto; padding: 15px;">
        
        <div style="background: var(--card); padding: 12px 18px; border-radius: 20px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i data-lucide="search" size="18" style="opacity: 0.5"></i>
            <input type="text" id="global-search" placeholder="Search luxury items, price, or sellers..." oninput="richSearch()" style="background: transparent; border: none; padding: 0; margin: 0;">
        </div>

        <div style="background: var(--card); padding: 20px; border-radius: 30px; border: 1px solid var(--border); margin-bottom: 30px;">
            <textarea id="item-desc" placeholder="Describe your item..."></textarea>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="number" id="item-price" placeholder="Price (₦)">
                <select id="item-pod">
                    <option value="false">Online Payment Only</option>
                    <option value="true">Allow Payment on Delivery</option>
                </select>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <label style="color: var(--primary); cursor: pointer; font-weight: 700; font-size: 0.85rem;">
                    <i data-lucide="camera"></i> Upload Image(s)
                    <input type="file" id="item-img" class="hidden" accept="image/*" onchange="handleImage(this)">
                </label>
                <button onclick="listItem()" class="btn-buy" style="width: auto; padding: 10px 30px;">List Item</button>
            </div>
        </div>

        <div id="feed"></div>
    </div>

    <div id="checkout-modal" class="hidden">
        <div class="modal-content">
            <h2 style="margin-bottom: 10px;">Checkout</h2>
            <p id="check-item-name" style="opacity: 0.7;"></p>
            <h3 id="check-item-price" style="color: var(--gold); margin-bottom: 20px;"></h3>
            
            <label style="font-size: 0.8rem; opacity: 0.5;">Delivery Address</label>
            <input type="text" id="delivery-addr" placeholder="House address, Hostel, Room...">
            
            <div id="pod-option-container" class="hidden" style="margin-top: 15px;">
                <button class="btn-buy" style="background: var(--accent); margin-bottom: 10px;" onclick="finalizeOrder('POD')">Confirm Payment on Delivery</button>
            </div>
            <button class="btn-buy" onclick="payWithPaystack()">Pay Now (Securely)</button>
            <p onclick="closeCheckout()" style="text-align: center; margin-top: 15px; cursor: pointer; opacity: 0.5;">Cancel</p>
        </div>
    </div>

    <script>
        // --- INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCwoZU08nKIh0EtMbUwiANjDwQOnF6BHw0",
            authDomain: "dolpgrace-103ad.firebaseapp.com",
            projectId: "dolpgrace-103ad",
            storageBucket: "dolpgrace-103ad.firebasestorage.app",
            messagingSenderId: "512869929238",
            appId: "1:512869929238:web:a4b00ebcdb5341b24c8037"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let user = JSON.parse(localStorage.getItem('urban_user'));
        let currentImage = null;
        let activeTransaction = null;
        let allItems = [];

        // --- CORE FUNCTIONS ---
        function handleImage(input) {
            const reader = new FileReader();
            reader.onload = (e) => currentImage = e.target.result;
            if(input.files[0]) reader.readAsDataURL(input.files[0]);
        }

        async function listItem() {
            const desc = document.getElementById('item-desc').value;
            const price = document.getElementById('item-price').value;
            const pod = document.getElementById('item-pod').value === 'true';
            
            if(!desc || !price || !currentImage) return alert("Please fill all details and add a photo.");

            await db.collection("posts").add({
                uName: user.name, uId: user.id,
                content: desc, price: parseFloat(price),
                image: currentImage, isPOD: pod,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            location.reload();
        }

        db.collection("posts").orderBy("timestamp", "desc").onSnapshot(snap => {
            allItems = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderItems(allItems);
        });

        function renderItems(items) {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            items.forEach(i => {
                feed.innerHTML += `
                    <div class="post-card">
                        <div class="price-tag">₦${i.price.toLocaleString()}</div>
                        <img src="${i.image}" style="width:100%; height:300px; object-fit:cover;">
                        <div style="padding: 20px;">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div>
                                    <b>${i.uName}</b>
                                    <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 5px;">${i.content}</p>
                                    ${i.isPOD ? `<span class="pod-badge">POD Available</span>` : ''}
                                </div>
                            </div>
                            <button class="btn-buy" style="margin-top: 15px;" onclick="openCheckout('${i.id}', '${i.price}', ${i.isPOD}, '${i.content}')">
                                <i data-lucide="zap" size="16"></i> BUY NOW
                            </button>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        // --- SEARCH LOGIC ---
        function richSearch() {
            const q = document.getElementById('global-search').value.toLowerCase();
            const filtered = allItems.filter(i => 
                i.content.toLowerCase().includes(q) || 
                i.price.toString().includes(q) ||
                i.uName.toLowerCase().includes(q)
            );
            renderItems(filtered);
        }

        // --- PAYMENT LOGIC ---
        function openCheckout(id, price, pod, desc) {
            activeTransaction = { id, price, desc };
            document.getElementById('check-item-name').innerText = desc.substring(0, 30) + "...";
            document.getElementById('check-item-price').innerText = "₦" + parseFloat(price).toLocaleString();
            document.getElementById('pod-option-container').classList.toggle('hidden', !pod);
            document.getElementById('checkout-modal').classList.remove('hidden');
        }

        function closeCheckout() { document.getElementById('checkout-modal').classList.add('hidden'); }

        function payWithPaystack() {
            const handler = PaystackPop.setup({
                key: 'pk_test_xxxxxxxxxxxxxxxxxxxxxxxxxx', // Replace with your Public Key
                email: user.email,
                amount: activeTransaction.price * 100, // Amount in kobo
                currency: 'NGN',
                callback: function(response) {
                    finalizeOrder('PAID_ONLINE', response.reference);
                },
                onClose: function() { alert('Transaction Cancelled'); }
            });
            handler.openIframe();
        }

        async function finalizeOrder(method, ref = 'N/A') {
            const addr = document.getElementById('delivery-addr').value;
            if(!addr) return alert("Please enter delivery address");

            await db.collection("orders").add({
                itemId: activeTransaction.id,
                buyer: user.name,
                buyerPhone: user.phone,
                amount: activeTransaction.price,
                method: method,
                address: addr,
                reference: ref,
                status: "Pending",
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert("Order Placed Successfully! Method: " + method);
            closeCheckout();
        }
    </script>
</body>
</html>

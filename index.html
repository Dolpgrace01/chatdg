<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DG HUB | Elite Node Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg: #000a07; --card: #064e3b20; --primary: #10b981; --gold: #fbbf24;
            --text: #f8fafc; --text-muted: #94a3b8; --border: rgba(251, 191, 36, 0.3);
            --sos: #ef4444; --glass: rgba(0, 10, 7, 0.95);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 110px; overflow-x: hidden; }
        .hidden { display: none !important; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        header { position: sticky; top: 0; background: var(--glass); backdrop-filter: blur(20px); padding: 15px 20px; border-bottom: 2px solid var(--border); z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        
        .elite-card { background: var(--card); border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--border); overflow: hidden; padding: 15px; position: relative; backdrop-filter: blur(10px); }
        .btn-elite { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; }
        .btn-elite:active { transform: scale(0.96); }
        
        .form-input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.5); color: white; outline: none; }
        
        /* Navigation & Badges */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--glass); display: flex; justify-content: space-around; padding: 15px 5px 35px; border-top: 2px solid var(--border); z-index: 1000; }
        .nav-link { color: var(--text-muted); display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; flex: 1; position: relative; font-size: 0.7rem; }
        .nav-link.active { color: var(--gold); }
        .badge { position: absolute; top: -5px; right: 20%; background: var(--sos); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; font-weight: 800; }

        /* Gallery & SOS Pulse */
        .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
        .gallery-item { aspect-ratio: 1/1; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        
        .sos-alert { border: 1px solid var(--sos); background: rgba(239, 68, 68, 0.1); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        pre { background: #000; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 0.75rem; overflow-x: auto; color: #10b981; border: 1px solid #333; margin: 10px 0; }

        #zoom-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 3000; display: none; align-items: center; justify-content: center; }
        #zoom-img { max-width: 95%; max-height: 85%; border-radius: 15px; border: 1px solid var(--gold); }

        #comment-drawer { position: fixed; bottom: -100%; left: 0; right: 0; height: 85vh; background: #000a07; border-top: 3px solid var(--gold); z-index: 2000; transition: 0.4s; border-radius: 35px 35px 0 0; display: flex; flex-direction: column; }
        #comment-drawer.open { bottom: 0; }
    </style>
</head>
<body>

    <div id="zoom-overlay" onclick="this.style.display='none'"><img id="zoom-img" src=""></div>

    <div id="pin-screen" class="container" style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <i data-lucide="shield-check" color="#fbbf24" size="60"></i>
        <h1 style="margin:20px 0;">ELITE <span style="color:var(--gold)">NODE</span></h1>
        <input type="password" id="node-pin" class="form-input" placeholder="ACCESS PIN" style="width:200px; text-align:center;">
        <button class="btn-elite" style="width:200px;" onclick="checkPin()">Decrypt Node</button>
    </div>

    <div id="auth-screen" class="container hidden" style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h2 style="color:var(--gold)">IDENTITY SETUP</h2>
        <div style="width: 280px; margin-top:20px;">
            <input type="text" id="reg-name" class="form-input" placeholder="Your Name">
            <input type="text" id="reg-matric" class="form-input" placeholder="Matric / ID">
            <button class="btn-elite" onclick="handleRegistration()">Verify Protocol</button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header>
            <div style="font-weight:800; color:var(--gold); font-size: 1.3rem;">DG <span style="color:var(--text)">HUB</span></div>
            <div id="top-avatar" onclick="switchTab('profile')"></div>
        </header>

        <div class="container">
            <section id="tab-market">
                <div class="elite-card">
                    <input type="text" id="m-title" class="form-input" placeholder="Item name...">
                    <input type="number" id="m-price" class="form-input" placeholder="Price (₦)">
                    <div id="m-previews" style="display:flex; gap:10px; overflow-x:auto; margin-bottom:10px;"></div>
                    <label style="color:var(--gold); cursor:pointer;"><i data-lucide="camera"></i><input type="file" class="hidden" multiple accept="image/*" onchange="processMedia(this, 'market')"></label>
                    <button class="btn-elite" onclick="publishMarket()">Post to Market</button>
                </div>
                <div id="market-feed"></div>
            </section>

            <section id="tab-dev" class="hidden">
                <div class="elite-card" style="border-color: var(--primary);">
                    <h3 style="color:var(--primary); margin-bottom:10px;">DEV-SYNC BOARD</h3>
                    <input type="text" id="task-input" class="form-input" placeholder="New group task...">
                    <button class="btn-elite" onclick="addTask()">Deploy Task</button>
                </div>
                <div id="task-list"></div>
            </section>

            <section id="tab-sos" class="hidden">
                <div class="elite-card sos-alert">
                    <h3 style="color:var(--sos);">SOS DEBUGGER</h3>
                    <textarea id="sos-text" class="form-input" placeholder="Describe the bug..."></textarea>
                    <textarea id="sos-code" class="form-input" style="font-family:monospace; height:80px;" placeholder="Paste broken code..."></textarea>
                    <button class="btn-elite" style="background:var(--sos);" onclick="publishSOS()">Broadcast SOS</button>
                </div>
                <div id="sos-feed"></div>
            </section>

            <section id="tab-profile" class="hidden">
                <div class="elite-card" style="text-align:center;">
                    <img id="p-img" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--gold); margin-bottom:10px;">
                    <h2 id="p-name"></h2>
                    <p id="p-matric" style="font-size:0.8rem; color:var(--text-muted);"></p>
                    <div style="margin-top:20px; text-align:left;">
                        <h4 style="color:var(--gold); border-bottom:1px solid var(--border); padding-bottom:5px;">MY COLLECTION</h4>
                        <div id="profile-gallery" class="gallery-grid"></div>
                    </div>
                    <button class="btn-elite" style="margin-top:30px; background:#450a0a;" onclick="logout()">Logout</button>
                </div>
            </section>
        </div>

        <nav class="bottom-nav">
            <div class="nav-link active" id="n-market" onclick="switchTab('market')"><i data-lucide="shopping-cart"></i><small>Market</small></div>
            <div class="nav-link" id="n-dev" onclick="switchTab('dev')"><i data-lucide="trello"></i><small>DevSync</small></div>
            <div class="nav-link" id="n-sos" onclick="switchTab('sos')"><i data-lucide="cpu"></i><small>PeerPair</small></div>
            <div class="nav-link" id="n-profile" onclick="switchTab('profile')"><i data-lucide="user"></i><small>Elite</small></div>
        </nav>
    </div>

    <div id="comment-drawer">
        <div style="width:40px; height:5px; background:var(--border); margin:15px auto; border-radius:10px;" onclick="closeDrawer()"></div>
        <div id="drawer-title" style="text-align:center; color:var(--gold); font-weight:800; font-size:0.8rem;"></div>
        <div id="comment-list" style="flex:1; overflow-y:auto; padding:20px;"></div>
        <div style="padding: 20px; display: flex; gap: 10px; background: rgba(0,0,0,0.5); padding-bottom: 40px;">
            <input type="text" id="c-input" class="form-input" placeholder="Type message..." style="margin-bottom:0">
            <button id="drawer-send-btn" class="btn-elite" style="width:auto; padding:0 20px;"><i data-lucide="send"></i></button>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC7ui6tasM3GgtetrLiqSO3qMbuzOvcdMU", authDomain: "dgmarketplace-6ae42.firebaseapp.com", projectId: "dgmarketplace-6ae42", storageBucket: "dgmarketplace-6ae42.firebasestorage.app", messagingSenderId: "650691092405", appId: "1:650691092405:web:e174e43bf5b93d7f13c3fc" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = JSON.parse(localStorage.getItem('urban_user'));
        let marketImgs = [], activeChatPartner = null, chatListener = null;

        window.onload = () => { if(currentUser) showApp(); lucide.createIcons(); };

        function checkPin() { if(document.getElementById('node-pin').value === "1231") { document.getElementById('pin-screen').classList.add('hidden'); document.getElementById('auth-screen').classList.remove('hidden'); } }

        async function handleRegistration() {
            const name = document.getElementById('reg-name').value;
            const matric = document.getElementById('reg-matric').value;
            if(!name || !matric) return;
            currentUser = { id: "U"+Date.now(), name, matric, pic: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}` };
            await db.collection("users").doc(currentUser.id).set(currentUser);
            localStorage.setItem('urban_user', JSON.stringify(currentUser));
            showApp();
        }

        function showApp() {
            document.querySelectorAll('.container').forEach(c => c.id !== 'main-app' && c.classList.add('hidden'));
            document.getElementById('pin-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('p-img').src = currentUser.pic;
            document.getElementById('p-name').innerText = currentUser.name;
            document.getElementById('p-matric').innerText = "ID: " + currentUser.matric;
            document.getElementById('top-avatar').innerHTML = `<img src="${currentUser.pic}" style="width:35px; border-radius:8px; border:1px solid var(--gold);">`;
            renderMarket(); renderDevSync(); renderSOS(); renderGallery();
        }

        // --- CORE UTILS ---
        function processMedia(input, type) {
            const files = Array.from(input.files).slice(0, 3);
            files.forEach(file => {
                const r = new FileReader();
                r.onload = e => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 600 / img.width;
                        canvas.width = 600; canvas.height = img.height * scale;
                        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                        marketImgs.push(canvas.toDataURL('image/jpeg', 0.7));
                        document.getElementById('m-previews').innerHTML += `<img src="${marketImgs[marketImgs.length-1]}" style="width:50px; height:50px; border-radius:5px;">`;
                    }
                };
                r.readAsDataURL(file);
            });
        }

        // --- TAB 1: MARKET ---
        async function publishMarket() {
            const title = document.getElementById('m-title').value;
            const price = document.getElementById('m-price').value;
            if(!title || !price || marketImgs.length === 0) return;
            await db.collection("marketplace").add({ uId: currentUser.id, uName: currentUser.name, title, price, images: marketImgs, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            location.reload();
        }

        function renderMarket() {
            db.collection("marketplace").orderBy("timestamp", "desc").onSnapshot(snap => {
                const f = document.getElementById('market-feed'); f.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    f.innerHTML += `<div class="elite-card" style="padding:0">
                        <img src="${d.images[0]}" onclick="openZoom('${d.images[0]}')" style="width:100%; height:200px; object-fit:cover;">
                        <div style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                            <div><b>${d.title}</b><br><small>₦${d.price}</small></div>
                            <button class="btn-elite" style="width:auto; padding:8px 15px;" onclick="startChat('${d.uId}', '${d.uName}')">Chat</button>
                        </div>
                    </div>`;
                });
            });
        }

        // --- TAB 2: DEV-SYNC ---
        async function addTask() {
            const t = document.getElementById('task-input').value;
            if(!t) return;
            await db.collection("tasks").add({ title: t, status: "todo", owner: null, ownerName: "", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('task-input').value = "";
        }

        function renderDevSync() {
            db.collection("tasks").orderBy("timestamp", "desc").onSnapshot(snap => {
                const l = document.getElementById('task-list'); l.innerHTML = "";
                snap.forEach(doc => {
                    const t = doc.data();
                    l.innerHTML += `<div class="elite-card" style="border-left:4px solid var(--primary);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b>${t.title}</b>
                            ${t.owner ? `<img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${t.ownerName}" style="width:25px;">` : `<button onclick="claimTask('${doc.id}')" style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:5px; font-size:0.6rem;">CLAIM</button>`}
                        </div>
                    </div>`;
                });
            });
        }
        async function claimTask(id) { await db.collection("tasks").doc(id).update({ owner: currentUser.id, ownerName: currentUser.name }); }

        // --- TAB 3: SOS PEER-PAIR ---
        async function publishSOS() {
            const text = document.getElementById('sos-text').value;
            const code = document.getElementById('sos-code').value;
            if(!text) return;
            await db.collection("sos").add({ uId: currentUser.id, uName: currentUser.name, text, code, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('sos-text').value = ""; document.getElementById('sos-code').value = "";
        }

        function renderSOS() {
            db.collection("sos").orderBy("timestamp", "desc").onSnapshot(snap => {
                const f = document.getElementById('sos-feed'); f.innerHTML = "";
                snap.forEach(doc => {
                    const s = doc.data();
                    f.innerHTML += `<div class="elite-card sos-alert">
                        <b>${s.uName} is stuck!</b>
                        <p style="margin:8px 0;">${s.text}</p>
                        ${s.code ? `<pre>${s.code}</pre>` : ''}
                        <button class="btn-elite" onclick="startChat('${s.uId}', '${s.uName}')">Assist Dev</button>
                    </div>`;
                });
            });
        }

        // --- TAB 4: PROFILE GALLERY ---
        function renderGallery() {
            db.collection("marketplace").where("uId", "==", currentUser.id).onSnapshot(snap => {
                const g = document.getElementById('profile-gallery'); g.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    g.innerHTML += `<div class="gallery-item" onclick="openZoom('${d.images[0]}')"><img src="${d.images[0]}"></div>`;
                });
            });
        }

        // --- SYSTEM ENGINES ---
        function startChat(pId, pName) {
            if(pId === currentUser.id) return;
            activeChatPartner = pId;
            const roomId = [currentUser.id, pId].sort().join('_');
            document.getElementById('drawer-title').innerText = "PRIVATE NODE: " + pName;
            document.getElementById('comment-drawer').classList.add('open');
            document.getElementById('drawer-send-btn').onclick = sendMessage;
            if(chatListener) chatListener();
            chatListener = db.collection("chats").doc(roomId).collection("messages").orderBy("timestamp", "asc").onSnapshot(snap => {
                const list = document.getElementById('comment-list'); list.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.senderId === currentUser.id;
                    list.innerHTML += `<div style="display:flex; justify-content:${isMe?'flex-end':'flex-start'}; margin-bottom:10px;">
                        <div style="background:${isMe? 'var(--primary)':'#1e293b'}; padding:10px 15px; border-radius:15px; max-width:80%; font-size:0.9rem;">${m.text}</div>
                    </div>`;
                });
                list.scrollTop = list.scrollHeight;
            });
        }

        async function sendMessage() {
            const text = document.getElementById('c-input').value;
            if(!text) return;
            const roomId = [currentUser.id, activeChatPartner].sort().join('_');
            await db.collection("chats").doc(roomId).collection("messages").add({ senderId: currentUser.id, text, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('c-input').value = "";
        }

        function switchTab(t) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.getElementById('n-'+t).classList.add('active');
            lucide.createIcons();
        }

        function openZoom(src) { document.getElementById('zoom-img').src = src; document.getElementById('zoom-overlay').style.display = 'flex'; }
        function closeDrawer() { document.getElementById('comment-drawer').classList.remove('open'); if(chatListener) chatListener(); }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>

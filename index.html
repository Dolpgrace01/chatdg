<style>
    .badge {
        position: absolute; top: -5px; right: 10px;
        background: #ef4444; color: white;
        font-size: 0.6rem; padding: 2px 6px;
        border-radius: 10px; display: none;
    }
    .nav-link { position: relative; }
</style>

<script>
    const firebaseConfig = { /* Your Config Here */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = JSON.parse(localStorage.getItem('urban_user'));
    let marketImgs = [], activeChatPartner = null, chatListener = null;

    window.onload = () => { 
        // PERSISTENCE: If user exists, skip PIN and Auth
        if(currentUser) {
            showApp();
            listenForGlobalNotifications(); // Start checking for messages
        }
        lucide.createIcons(); 
    };

    function haptic() { if(window.navigator.vibrate) window.navigator.vibrate(50); }

    // --- COMPRESSOR & LIMIT (Max 3) ---
    function previewMarket(input) {
        marketImgs = []; 
        const area = document.getElementById('m-previews'); 
        area.innerHTML = "";
        
        // Strictly limit to 3 files
        const files = Array.from(input.files).slice(0, 3);
        
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Compress to 0.7 quality
                    const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                    marketImgs.push(compressedData);
                    
                    area.innerHTML += `<img src="${compressedData}" style="width:60px; height:60px; border-radius:10px; border:1px solid var(--gold);">`;
                };
            };
            reader.readAsDataURL(file);
        });
    }

    // --- NOTIFICATION LOGIC ---
    function listenForGlobalNotifications() {
        // Query all chat rooms where the user is a participant
        db.collectionGroup("messages")
          .where("senderId", "!=", currentUser.id)
          .orderBy("senderId") // Required for inequality filters
          .orderBy("timestamp", "desc")
          .limit(1)
          .onSnapshot(snap => {
              if (!snap.empty && !document.getElementById('comment-drawer').classList.contains('open')) {
                  document.getElementById('n-chat-badge').style.display = 'block';
                  // Optional: Trigger phone vibration for new message
                  haptic();
              }
          });
    }

    // --- UPDATED NAVIGATION ---
    function switchTab(t) {
        haptic();
        if(t === 'chat') document.getElementById('n-chat-badge').style.display = 'none';
        
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        document.getElementById('n-'+t).classList.add('active');
    }

    // --- AUTH GATES ---
    function checkPin() {
        if(document.getElementById('node-pin').value === "1231") {
            document.getElementById('pin-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
        } else { alert("Invalid Access Code"); }
    }

    async function handleRegistration() {
        const name = document.getElementById('reg-name').value;
        const matric = document.getElementById('reg-matric').value;
        if(!name || !matric) return;
        currentUser = { id: "U"+Date.now(), name, matric, pic: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}` };
        await db.collection("users").doc(currentUser.id).set(currentUser);
        localStorage.setItem('urban_user', JSON.stringify(currentUser));
        showApp();
        listenForGlobalNotifications();
    }
</script>

<nav class="bottom-nav">
    <div class="nav-link" id="n-chat" onclick="switchTab('chat')">
        <span id="n-chat-badge" class="badge">NEW</span>
        <i data-lucide="message-square"></i><small>Chat</small>
    </div>
    </nav>

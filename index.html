<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DG HUB | OBSIDIAN NODE</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg: #000000; --card: #0a0a0a; --primary: #00ff41; --secondary: #008f11;
            --text: #ffffff; --text-dim: #666666; --border: #1a1a1a; --sos: #ff003c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 100px; overflow-x: hidden; }
        .hidden { display: none !important; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }

        header { position: sticky; top: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); padding: 15px 20px; border-bottom: 1px solid var(--border); z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .node-title { font-family: 'JetBrains Mono', monospace; font-weight: 800; color: var(--primary); letter-spacing: -1px; }

        .elite-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px; overflow: hidden; padding: 16px; transition: 0.2s; }
        .elite-card:active { border-color: var(--primary); }

        .btn-main { width: 100%; padding: 14px; background: var(--primary); color: #000; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        .btn-outline { background: none; border: 1px solid var(--primary); color: var(--primary); padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        
        .form-input { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; border: 1px solid var(--border); background: #050505; color: white; outline: none; font-size: 0.9rem; }
        .form-input:focus { border-color: var(--primary); }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #050505; display: flex; justify-content: space-around; padding: 12px 0 35px; border-top: 1px solid var(--border); z-index: 1000; }
        .nav-link { color: var(--text-dim); display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: 0.3s; }
        .nav-link.active { color: var(--primary); }

        /* Features */
        .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 15px; }
        .gallery-item { aspect-ratio: 1/1; background: #111; border-radius: 4px; overflow: hidden; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }

        .sos-tag { color: var(--sos); font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: bold; border: 1px solid var(--sos); padding: 2px 6px; border-radius: 4px; margin-bottom: 8px; display: inline-block; }
        pre { background: #050505; padding: 12px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--secondary); border: 1px solid #111; overflow-x: auto; margin: 10px 0; }

        #drawer { position: fixed; bottom: -100%; left: 0; right: 0; height: 85vh; background: #080808; border-top: 2px solid var(--primary); z-index: 2000; transition: 0.3s cubic-bezier(0, 0, 0.2, 1); border-radius: 20px 20px 0 0; display: flex; flex-direction: column; }
        #drawer.open { bottom: 0; }
    </style>
</head>
<body>

    <div id="pin-screen" class="container" style="height:90vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h2 class="node-title" style="font-size: 2rem; margin-bottom: 30px;">AUTH_REQUIRED</h2>
        <input type="password" id="node-pin" class="form-input" placeholder="ACCESS_CODE" style="text-align:center; width: 200px; letter-spacing: 4px;">
        <button class="btn-main" onclick="checkPin()" style="width: 200px;">Execute</button>
    </div>

    <div id="auth-screen" class="container hidden" style="height:90vh; display:flex; flex-direction:column; justify-content:center;">
        <h2 class="node-title">IDENTITY_LOG</h2>
        <p style="color:var(--text-dim); font-size: 0.8rem; margin-bottom: 20px;">Initialize user profile on the obsidian node.</p>
        <input type="text" id="reg-name" class="form-input" placeholder="User Handle">
        <input type="text" id="reg-matric" class="form-input" placeholder="Department ID">
        <button class="btn-main" onclick="handleRegistration()">Verify Identity</button>
    </div>

    <div id="main-app" class="hidden">
        <header>
            <div class="node-title">OBSIDIAN_NODE</div>
            <div id="top-avatar" onclick="switchTab('profile')"></div>
        </header>

        <div class="container">
            <section id="tab-market">
                <div class="elite-card">
                    <input type="text" id="m-title" class="form-input" placeholder="Product Name">
                    <input type="number" id="m-price" class="form-input" placeholder="Price (NGN)">
                    <div id="m-previews" style="display:flex; gap:8px; overflow-x:auto; margin-bottom:10px;"></div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label style="color:var(--primary); cursor:pointer;"><i data-lucide="camera" size="20"></i><input type="file" class="hidden" multiple accept="image/*" onchange="processMedia(this)"></label>
                        <button class="btn-outline" onclick="publishMarket()">Post Asset</button>
                    </div>
                </div>
                <div id="market-feed"></div>
            </section>

            <section id="tab-dev" class="hidden">
                <div class="elite-card">
                    <h4 class="node-title" style="margin-bottom:12px;">PROJECT_BOARD</h4>
                    <input type="text" id="task-input" class="form-input" placeholder="New objective...">
                    <button class="btn-main" onclick="addTask()">Deploy Objective</button>
                </div>
                <div id="task-list"></div>
            </section>

            <section id="tab-sos" class="hidden">
                <div class="elite-card" style="border-color: var(--sos);">
                    <div class="sos-tag">STATUS: CRITICAL</div>
                    <textarea id="sos-text" class="form-input" placeholder="Describe current logic error..." style="height:80px;"></textarea>
                    <textarea id="sos-code" class="form-input" style="font-family:'JetBrains Mono'; height:80px; font-size:0.7rem;" placeholder="Paste source code..."></textarea>
                    <button class="btn-main" style="background:var(--sos); color:white;" onclick="publishSOS()">Broadcast Signal</button>
                </div>
                <div id="sos-feed"></div>
            </section>

            <section id="tab-profile" class="hidden">
                <div class="elite-card" style="text-align:center;">
                    <img id="p-img" style="width:70px; height:70px; border-radius:8px; border:1px solid var(--primary); margin-bottom:12px;">
                    <h2 id="p-name" class="node-title"></h2>
                    <p id="p-matric" style="font-family:'JetBrains Mono'; font-size:0.7rem; color:var(--text-dim);"></p>
                    
                    <div style="margin-top:24px; text-align:left;">
                        <h5 style="color:var(--primary); font-size:0.7rem; text-transform:uppercase; border-bottom:1px solid #111; padding-bottom:5px;">User_Vault</h5>
                        <div id="profile-gallery" class="gallery-grid"></div>
                    </div>
                    <button class="btn-outline" style="margin-top:30px; border-color:var(--sos); color:var(--sos); width:100%;" onclick="logout()">Terminate Connection</button>
                </div>
            </section>
        </div>

        <nav class="bottom-nav">
            <div class="nav-link active" id="n-market" onclick="switchTab('market')"><i data-lucide="database"></i><small>Market</small></div>
            <div class="nav-link" id="n-dev" onclick="switchTab('dev')"><i data-lucide="layers"></i><small>DevSync</small></div>
            <div class="nav-link" id="n-sos" onclick="switchTab('sos')"><i data-lucide="terminal"></i><small>PeerPair</small></div>
            <div class="nav-link" id="n-profile" onclick="switchTab('profile')"><i data-lucide="cpu"></i><small>Node</small></div>
        </nav>
    </div>

    <div id="drawer">
        <div style="width:40px; height:4px; background:#222; margin:15px auto; border-radius:10px;" onclick="closeDrawer()"></div>
        <div id="drawer-title" style="text-align:center; color:var(--primary); font-family:'JetBrains Mono'; font-size:0.8rem; margin-bottom:10px;"></div>
        <div id="drawer-content" style="flex:1; overflow-y:auto; padding:20px;"></div>
        <div style="padding: 20px; display: flex; gap: 10px; background: #000; padding-bottom: 40px;">
            <input type="text" id="c-input" class="form-input" placeholder="Enter transmission..." style="margin-bottom:0">
            <button id="drawer-send-btn" class="btn-main" style="width:auto; padding:0 20px;"><i data-lucide="send"></i></button>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC7ui6tasM3GgtetrLiqSO3qMbuzOvcdMU", authDomain: "dgmarketplace-6ae42.firebaseapp.com", projectId: "dgmarketplace-6ae42", storageBucket: "dgmarketplace-6ae42.firebasestorage.app", messagingSenderId: "650691092405", appId: "1:650691092405:web:e174e43bf5b93d7f13c3fc" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = JSON.parse(localStorage.getItem('urban_user'));
        let marketImgs = [], activeChatPartner = null, chatListener = null;

        window.onload = () => { if(currentUser) showApp(); lucide.createIcons(); };

        function checkPin() { if(document.getElementById('node-pin').value === "1231") { document.getElementById('pin-screen').classList.add('hidden'); document.getElementById('auth-screen').classList.remove('hidden'); } }

        async function handleRegistration() {
            const name = document.getElementById('reg-name').value;
            const matric = document.getElementById('reg-matric').value;
            if(!name || !matric) return;
            currentUser = { id: "U"+Date.now(), name, matric, pic: `https://api.dicebear.com/7.x/bottts/svg?seed=${name}` };
            await db.collection("users").doc(currentUser.id).set(currentUser);
            localStorage.setItem('urban_user', JSON.stringify(currentUser));
            showApp();
        }

        function showApp() {
            document.getElementById('pin-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('p-img').src = currentUser.pic;
            document.getElementById('p-name').innerText = currentUser.name.toUpperCase();
            document.getElementById('p-matric').innerText = "NODE_ID: " + currentUser.matric;
            document.getElementById('top-avatar').innerHTML = `<img src="${currentUser.pic}" style="width:32px; border:1px solid var(--primary); border-radius:4px;">`;
            renderMarket(); renderDevSync(); renderSOS(); renderGallery();
        }

        function processMedia(input) {
            Array.from(input.files).forEach(file => {
                const r = new FileReader();
                r.onload = e => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 600 / img.width;
                        canvas.width = 600; canvas.height = img.height * scale;
                        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                        const data = canvas.toDataURL('image/jpeg', 0.6);
                        marketImgs.push(data);
                        document.getElementById('m-previews').innerHTML += `<img src="${data}" style="width:40px; height:40px; border-radius:4px; border:1px solid #333;">`;
                    }
                };
                r.readAsDataURL(file);
            });
        }

        async function publishMarket() {
            const title = document.getElementById('m-title').value;
            const price = document.getElementById('m-price').value;
            if(!title || !price || marketImgs.length === 0) return;
            await db.collection("marketplace").add({ uId: currentUser.id, uName: currentUser.name, title, price, images: marketImgs, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            location.reload();
        }

        function renderMarket() {
            db.collection("marketplace").orderBy("timestamp", "desc").onSnapshot(snap => {
                const f = document.getElementById('market-feed'); f.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    f.innerHTML += `<div class="elite-card" style="padding:0">
                        <img src="${d.images[0]}" style="width:100%; height:180px; object-fit:cover; border-bottom:1px solid var(--border);">
                        <div style="padding:12px; display:flex; justify-content:space-between; align-items:center;">
                            <div><div style="font-size:0.9rem; font-weight:700;">${d.title}</div><div style="color:var(--primary); font-size:0.8rem; font-family:'JetBrains Mono'">NGN ${d.price}</div></div>
                            <button class="btn-outline" style="font-size:0.7rem; padding:5px 10px;" onclick="startChat('${d.uId}', '${d.uName}')">Contact</button>
                        </div>
                    </div>`;
                });
            });
        }

        async function addTask() {
            const t = document.getElementById('task-input').value;
            if(!t) return;
            await db.collection("tasks").add({ title: t, owner: null, ownerName: "", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('task-input').value = "";
        }

        function renderDevSync() {
            db.collection("tasks").orderBy("timestamp", "desc").onSnapshot(snap => {
                const l = document.getElementById('task-list'); l.innerHTML = "";
                snap.forEach(doc => {
                    const t = doc.data();
                    l.innerHTML += `<div class="elite-card" style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.9rem;">> ${t.title}</span>
                        ${t.owner ? `<span style="font-size:0.7rem; color:var(--primary)">@${t.ownerName}</span>` : `<button onclick="claimTask('${doc.id}')" class="btn-outline" style="font-size:0.6rem; padding:4px 8px;">CLAIM</button>`}
                    </div>`;
                });
            });
        }
        async function claimTask(id) { await db.collection("tasks").doc(id).update({ owner: currentUser.id, ownerName: currentUser.name }); }

        async function publishSOS() {
            const text = document.getElementById('sos-text').value;
            const code = document.getElementById('sos-code').value;
            if(!text) return;
            await db.collection("sos").add({ uId: currentUser.id, uName: currentUser.name, text, code, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('sos-text').value = ""; document.getElementById('sos-code').value = "";
        }

        function renderSOS() {
            db.collection("sos").orderBy("timestamp", "desc").onSnapshot(snap => {
                const f = document.getElementById('sos-feed'); f.innerHTML = "";
                snap.forEach(doc => {
                    const s = doc.data();
                    f.innerHTML += `<div class="elite-card" style="border-left: 2px solid var(--sos);">
                        <div style="font-size:0.8rem; font-weight:700; color:var(--sos); margin-bottom:8px;">SIGNAL_FROM: ${s.uName}</div>
                        <p style="font-size:0.85rem; line-height:1.4;">${s.text}</p>
                        ${s.code ? `<pre>${s.code}</pre>` : ''}
                        <button class="btn-main" style="margin-top:12px; height:35px; background:white;" onclick="startChat('${s.uId}', '${s.uName}')">Debug Protocol</button>
                    </div>`;
                });
            });
        }

        function renderGallery() {
            db.collection("marketplace").where("uId", "==", currentUser.id).onSnapshot(snap => {
                const g = document.getElementById('profile-gallery'); g.innerHTML = "";
                snap.forEach(doc => g.innerHTML += `<div class="gallery-item"><img src="${doc.data().images[0]}"></div>`);
            });
        }

        function startChat(pId, pName) {
            if(pId === currentUser.id) return;
            activeChatPartner = pId;
            const roomId = [currentUser.id, pId].sort().join('_');
            document.getElementById('drawer-title').innerText = "CHANNEL_ID: " + pName.toUpperCase();
            document.getElementById('drawer').classList.add('open');
            document.getElementById('drawer-send-btn').onclick = sendMessage;
            if(chatListener) chatListener();
            chatListener = db.collection("chats").doc(roomId).collection("messages").orderBy("timestamp", "asc").onSnapshot(snap => {
                const list = document.getElementById('drawer-content'); list.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.senderId === currentUser.id;
                    list.innerHTML += `<div style="display:flex; justify-content:${isMe?'flex-end':'flex-start'}; margin-bottom:12px;">
                        <div style="background:${isMe?'#222':'var(--primary)'}; color:${isMe?'white':'black'}; padding:10px 14px; border-radius:8px; max-width:80%; font-size:0.85rem;">${m.text}</div>
                    </div>`;
                });
                list.scrollTop = list.scrollHeight;
            });
        }

        async function sendMessage() {
            const t = document.getElementById('c-input').value;
            if(!t) return;
            const roomId = [currentUser.id, activeChatPartner].sort().join('_');
            await db.collection("chats").doc(roomId).collection("messages").add({ senderId: currentUser.id, text: t, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('c-input').value = "";
        }

        function switchTab(t) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.getElementById('n-'+t).classList.add('active');
            lucide.createIcons();
        }

        function closeDrawer() { document.getElementById('drawer').classList.remove('open'); if(chatListener) chatListener(); }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
